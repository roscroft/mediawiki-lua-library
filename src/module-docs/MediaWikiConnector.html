<!DOCTYPE html>
<html>
<head>
    <title>MediaWikiConnector Module Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #333; border-bottom: 2px solid #ccc; }
        h2 { color: #666; margin-top: 30px; }
        .function { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #4CAF50; }
        .definition { font-family: monospace; background: #eee; padding: 10px; border-radius: 4px; }
        .description { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>MediaWikiConnector Module</h1>
    <div class="description">MediaWiki Connector Module This module provides direct access to MediaWiki's mw global and Scribunto functionality by connecting to your running MediaWiki container, eliminating the need for conditional imports. Usage: local mwConnector = require('MediaWikiConnector') local mw = mwConnector.getMW() -- Now you can use mw.html, mw.text, etc. directly</div>
    <h2>Functions</h2>
    <div class="function">
        <h3>create</h3>
        <div class="definition">create = function(tag)</div>
        <div class="description">MediaWiki Connector Module

This module provides direct access to MediaWiki's mw global and Scribunto functionality
by connecting to your running MediaWiki container, eliminating the need for conditional imports.

Usage:
    local mwConnector = require('MediaWikiConnector')
    local mw = mwConnector.getMW()
    -- Now you can use mw.html, mw.text, etc. directly


local MediaWikiConnector = {}

-- Configuration
local MEDIAWIKI_API_URL = os.getenv('MEDIAWIKI_API_URL') or 'http://localhost:8080/api.php'
local SCRIBUNTO_TEST_ENDPOINT = os.getenv('SCRIBUNTO_TEST_ENDPOINT') or 'http://localhost:8080/test-script.php'

-- Cached mw global
local cached_mw = nil


Execute Lua code directly in your MediaWiki container via the PHP test script
This gives you real access to the mw global instead of mocks

local function executeInMediaWiki(luaCode)
    local success, result = pcall(function()
        -- Create a temporary file with the Lua code
        local tempFile = '/tmp/mediawiki_test_' .. os.time() .. '.lua'
        local file = io.open(tempFile, 'w')
        if not file then
            error('Cannot create temporary file')
        end

        file:write(luaCode)
        file:close()

        -- Execute via Docker
        local cmd = string.format(
            'docker exec mediawiki-dev php /var/www/html/test-script.php %s 2>/dev/null',
            tempFile
        )

        local handle = io.popen(cmd)
        if not handle then
            error('Cannot execute Docker command')
        end

        local output = handle:read('*a')
        local success = handle:close()

        -- Clean up
        os.remove(tempFile)

        if not success then
            error('MediaWiki execution failed')
        end

        return output
    end)

    if success then
        return result
    else
        -- Fallback to mock environment
        return nil
    end
end


Get a real mw global from your running MediaWiki instance

function MediaWikiConnector.getMW()
    if cached_mw then
        return cached_mw
    end

    -- Try to get real mw from MediaWiki container
    local mwTestCode = [[
        -- Test if mw global is available
        if mw and mw.html then
            return "MW_AVAILABLE"
        else
            return "MW_NOT_AVAILABLE"
        end
    

    local result = executeInMediaWiki(mwTestCode)

    if result and result:find("MW_AVAILABLE") then
        -- Create a proxy that executes in MediaWiki
        cached_mw = {
            html = {</div>
    </div>
    <div class="function">
        <h3>checkType</h3>
        <div class="definition">checkType = function(name, argIdx, arg, expectType, nilOk)</div>
        <div class="description">Test if MediaWiki container is available and responsive

function MediaWikiConnector.testConnection()
    local result = executeInMediaWiki('return "test"')
    return result ~= nil
end


Get libraryUtil from MediaWiki

function MediaWikiConnector.getLibraryUtil()
    if MediaWikiConnector.testConnection() then
        -- Return real libraryUtil proxy
        return {</div>
    </div>

</body>
</html>